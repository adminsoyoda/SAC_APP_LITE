<script type="text/javascript">
    (function(){
        $("#containerGest").hide();
        BDConsulta("SELECT count(*) 'CONT' FROM APP_PEDIDO WHERE IDGESTION = '"+IDGESTION+"' AND CARDCODE = '"+CARDCODE+"' AND EMPRESA = '"+ masterEmpresa.trim()+"'", function (obj) {
            if(obj.CONT==0)
            {
                fn_ListaMotivo();
                alert("No ha ingresado ningun pedido!");
                $("#App_Motivo").show();
            }
            setTimeout(function() {
                $("#containerGest").show();
            }, 100);
        });   

        BDConsulta("SELECT * FROM APP_PLAN_TRABAJO WHERE CARDCODE = '"+CARDCODE+"';", function (obj1) {
            $("#Op_Plan1").val(obj1.PLANACCION1);
            $("#Op_Plan2").val(obj1.PLANACCION2);
            $("#Op_Plan3").val(obj1.PLANACCION3);
        });             
    })();

    function fn_ListaMotivo(){
        $("#opt_Motivo").html("");
        BDConsultaOBJ("SELECT * FROM APP_MOTIVO ORDER BY DESCRIPCION ASC", function (obj) {
            for (var i = 0; i < obj.rows.length; i++) 
            {
                var row = obj.rows.item(i);
                $("#opt_Motivo").append("<option value='"+row.ID+"'>"+row.DESCRIPCION+"</option>");
            }  
        });
    }

    function fn_SaveGestion(){
        
        if($("#Op_InformeGestion").val()==""){
            alert("Debe ingresar el informe de la Gestion!");
            return;
        }

        var TIPOGESTION="";
        var FECHACIERRE="";
        var DIFTIEMPO="00:00";
        var NOW = new Date();
        fn_fechaformato(NOW,1,function(RETORNO){
           FECHACIERRE=RETORNO;
        })
     
        var Plan1 = 0;
        var Plan2 = 0;
        var PlanOp = 0;

        if( $("#Chk_Plan1").is(':checked')){ Plan1 = 1 }
        if( $("#Chk_Plan2").is(':checked')){ Plan2 = 1 }
        if( $("#Chk_Plan3").is(':checked')){ PlanOp = 1 }

        $("#loader_sys_btn_show").click();

        /*objGps.continueGps(function(){*/
            BDConsulta("SELECT * FROM APP_GESTION WHERE IDGESTION = '"+ IDGESTION +"' AND EMPRESA='"+masterEmpresa.trim()+"' ;", function (obj) {
                BDActualizacion("UPDATE APP_GESTION SET FECHACIERRE = '"+FECHACIERRE+"', MOTIVO = '"+ $("#opt_Motivo").val() +"', INFORME='"+ $("#Op_InformeGestion").val() +"', ESTADOGESTION='C', PLAN1 = '"+Plan1+"',PLAN2 = '"+Plan2+"',PLANOP = '"+PlanOp+"' WHERE IDGESTION = '"+ IDGESTION +"' AND EMPRESA='"+masterEmpresa.trim()+"';");

                alert("La gestion del cliente "+obj.CARDNAME+" finalizo con exito!");
                $("#loader_sys_btn_hide").click();
                loadOption2('pages/10000200.html')
            });
        /*    objGps.getCoordenates(function(){},function(){},false,"UPDATE APP_GESTION SET LONCIERRE={LONGITUD},LATCIERRE={LATITUD} WHERE IDGESTION="+IDGESTION+"");
        },function(){
        });*/

        $("#loader_sys_btn_hide").click();
    }
</script>
<div role="container" id="containerGest">
    <div data-role="header" >
        <a href="#" class="ui-btn ui-shadow ui-corner-all ui-icon-tag ui-btn-icon-notext"></a>
        <h1 style="font-size: 16px;">Cierre de Gestion</h1>
    </div>
    <div>

        <textarea placeholder="Informe de Gestion" style="margin-top: 30px;" id="Op_InformeGestion"></textarea>

        <div class="form-group" id="App_Motivo" style="display:none;padding-top: 30px;">
            <label><strong>Motivo de no Gestion:</strong></label>
            <select id="opt_Motivo"></select>
        </div>

        <fieldset data-role="controlgroup" data-iconpos="right" style="padding-top: 30px;">
            <input type="checkbox" name="Chk_Plan1" id="Chk_Plan1">
            <label for="Chk_Plan1" style="border-radius: 0;">Plan de Trabajo #1</label>
            <textarea id="Op_Plan1" style="margin: 0;border-radius: 0;opacity: 1" disabled></textarea>
        </fieldset>
        <fieldset data-role="controlgroup" data-iconpos="right">
            <input type="checkbox" name="Chk_Plan2" id="Chk_Plan2">
            <label for="Chk_Plan2" style="border-radius: 0;">Plan de Trabajo #2</label>
            <textarea id="Op_Plan2" style="margin: 0;border-radius: 0;opacity: 1" disabled></textarea>
        </fieldset>
        <fieldset data-role="controlgroup" data-iconpos="right">
            <input type="checkbox" name="Chk_Plan3" id="Chk_Plan3">
            <label for="Chk_Plan3" style="border-radius: 0;">Plan Opcional</label>
            <textarea id="Op_Plan3" style="margin: 0;border-radius: 0;opacity: 1" disabled></textarea>
        </fieldset>

        <div style="text-align: right;padding-top: 12px">
            <div class="ui-grid-a">
                <div class="ui-block-a">
                    <a href="#" class="ui-btn btn-lg-right ui-btn-icon-left ui-icon-delete" style="" onclick="fn_ReturnMain()">Cancelar</a>
                </div>
                <div class="ui-block-b">
                    <a href="#" class="ui-btn btn-lg-right cus-suc-ele ui-btn-icon-left ui-icon-check" style="" onclick="fn_SaveGestion();">Fin de Gestion</a> 
                </div>
            </div>
        </div>
    </div>
</div>