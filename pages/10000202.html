<script type="text/javascript">
    var i_LINES = 0;
    var i_LINESCOUNT = 1;
    var e = jQuery.Event("keypress");e.which = 13;e.keyCode=13;
    var testEmail = /^[A-Z0-9._%+-]+@([A-Z0-9-]+\.)+[A-Z]{2,4}$/i;

    var FECHAAPERTURA = new Date();
    var IDGESTION=0;
    var CARDCODE="";
    var AppDecimales= 4 ;
    //var strIVA = "#IVA#";
    var strIVA = "14";

    (function(){
        AppPedidoFormulario("","N");
    })();

    function fn_ListaDireccion(){
        $("#opt_ListaDireccion").html("<option value=''>Seleccionar Dirección</option>");
        BDConsultaOBJ("SELECT * FROM APP_DIRECCION WHERE CARDCODE='"+CARDCODE+"' AND EMPRESA='"+masterEmpresa.trim()+"'  ORDER BY CODIGO ASC", function (obj) {
            for (var i = 0; i < obj.rows.length; i++) {
                var row = obj.rows.item(i);
                $("#opt_ListaDireccion").append("<option value='"+row.CODIGO+"'>"+row.DIRECCION+"</option>");
            }  
        });
    }

    function fn_ListaTransporte(){
        $("#opt_ListaTransporte").html("<option value=''>Seleccionar Transporte</option>");
        BDConsultaOBJ("SELECT * FROM APP_TRANSPORTE ORDER BY DESCRIPCION ASC", function (obj) {
            for (var i = 0; i < obj.rows.length; i++) {
                var row = obj.rows.item(i);
                $("#opt_ListaTransporte").append("<option value='"+row.ID+"'>"+row.DESCRIPCION+"</option>");
            }  
        });
    }

    function AppPedidoFormulario(DocEntry, Estado) {
        $("#PedidoFormularioDocEntry").val(DocEntry);
        $("#PedidoFormularioEstado").val(Estado);
        fn_ListaDireccion();
        fn_ListaTransporte();
        fn_DatosPedido(); 
    }

    function fn_DatosPedido()
    {
        fn_DatosCliente();
        if($("#PedidoFormularioEstado").val() != "N"){
            i_LINES=0;

            var DOCENTRY= $("#PedidoFormularioDocEntry").val();
            //SE OBTIENEN LOS DATOS DEL PEDDOSSSSS
            BDConsultaOBJ("SELECT * FROM APP_PEDIDO WHERE DOCENTRY_APP="+ DOCENTRY +" and EMPRESA='" + masterEmpresa.trim() + "' ;",function (obj) {
                for (var i = 0; i < obj.rows.length; i++) {
                    var row = obj.rows.item(i);
                    $("#tagLineasPedido").html("");
                    $("#tagORDCOMPRA").val(row.ORDENCOMPRA);
                    $("#tagFECHACREACION").val(row.CREATEDATE);
                    $("#tagENTREGADATE1").val(row.ENTREGADATE);
                    $("#tagNUMEROSAC").val(row.DOCENTRY);
                    $("#tagNUMEROSAP").val(row.DOCNUM_SAP);
                    $("#opt_ListaDireccion").val(row.ADDRESS);
                    $("#opt_ListaTransporte").val(row.IDTRANSPORTE);
                    $("#NOTAS").val(row.NOTAS);
                    $("#tagCELLPHONE1").val(row.CELLPHONE);
                    $("#tagPHONE1").val(row.CAMPO_1);

                    $('#idExtAprov').prop('checked', ((row.CAMPO_2 == "Y")? true: false));

                    fn_SeleccionItemsReload(row.DOCENTRY_APP,row.TIPODOCUMENTO);
                    fn_Controles();

                    if(row.TIPODOCUMENTO =='PEDIDO'){
                        fn_factura(row.DOCENTRY,row.DOCNUM_SAP,row.CARDCODE);
                    }
                };
            });
        }else{        
            i_LINES=0;
            $("#tagFECHACREACION").val("...");
            $("#tagNUMEROSAC").val  ("...");
            $("#tagNUMEROSAP").val  ("...");
            $("#tagLineasPedido").val("");
            $("#tagORDCOMPRA").val("");
            $('#idExtAprov').prop('checked', false);
            //fn_CalculoItemList("");
            fn_fechaformato(FECHAAPERTURA,2,function(RETORNO){
                $("#tagENTREGADATE1").val(RETORNO);
            });
            fn_Controles();
        }

        SoloNumero("tagORDCOMPRA");
    }  

    function fn_DatosCliente(){
        //$("#opt_ListaCliente").val(CARDCODE);
        //$("#opt_ListaCliente").prop("disabled",true);
        $("#hdn_CARDCODE").val(CARDCODE); 
        for (var i = 0; i < Arr_CLIENTE.rows.length; i++) {
            var row = Arr_CLIENTE.rows.item(i);
            $("#tagCARDCODE").val(row.CARDCODE);
            $("#tagCARDNAME").val(row.CARDNAME);                  
            $("#tagPHONE1").val(row.PHONE1);
            $("#tagCELLPHONE1").val(row.CELLPHONE);
            $("#tagGRUPO").val(row.GROUPNAME);
            $("#tagLICTRADNUM").val(row.LICTRADNUM);
            $("#tagMAILCITY").val(row.MAILCITY);
            $("#tagE_MAIL").val(row.E_MAIL);
            $(".div_PedidoFormulario").show();
            SoloNumero("tagPHONE1");  
            SoloNumero("tagCELLPHONE1");            
            break;
        };
    }

    function fn_Controles()
    {
        var inputs = document.getElementsByName("inputModify")
        var elemtHide = document.getElementsByName("HideEle")
        if($("#PedidoFormularioEstado").val() == "PEDIDO")
        {
            //BLOQUEAR INPUT
            for (var i = 0; i <inputs.length; i++) {
                inputs[i].disabled = true;
                inputs[i].style.background = "white";
            };

            $("#btn_GuardarCotizacion").hide();
            $("#btn_GuardarPedido").hide();
            $("#btn_NuevaLinea").hide();
            $("#opt_ListaDireccion").prop('disabled', true); 
            $("#opt_ListaTransporte").prop('disabled', true); 
            $("#btn_Cliente").prop('disabled', true);  
            $("#tagORDCOMPRA").prop('placeholder', "");  

            //OCULTAR BOTONES DE GUARDADO Y DE ELIMINACION
            for (var i = 0; i <elemtHide.length; i++) 
            {
                elemtHide[i].style.display="none";
            };

        }
        else
        {
            //DESBLOQUEAR INPUT
            for (var i = 0; i <inputs.length; i++) {
                inputs[i].disabled = false;
                inputs[i].style.background = "white";
            };

            $("#btn_GuardarCotizacion").show();
            $("#btn_GuardarPedido").show();
            $("#btn_NuevaLinea").show();
            $("#opt_ListaDireccion").prop('disabled', false); 
            $("#opt_ListaTransporte").prop('disabled', false);
            $("#btn_Cliente").prop('disabled', false);  

            //MOSTRAR BOTONES DE GUARDADO Y DE ELIMINACION
            for (var i = 0; i <elemtHide.length; i++) {
                elemtHide[i].style.display="block";
            };
        }
    }

  	function fn_ListaItemsSearch(evento) 
    {
        var key = validaEvento(evento);
        var filtro = "N";

          $("#tagItemsSearch_Lineas").html("");

        if ($('#idExtAprov').is(":checked"))
        {
          filtro = "Y";
        }

        if (key == 13) {
            hideKeyboard(evento);        
            $("#loader_sys_btn_show").click();
            var ITEMCODE=$("#tagSearchITEMCODE").val().replace(/ /g, '%');
            var ITEMNAME=$("#tagSearchITEMCODE").val().replace(/ /g, '%');
            var ITMSGRPNAM=$("#tagSearchITEMCODE").val().replace(/ /g, '%');

            BDConsultaOBJ("SELECT ITEMCODE,ITEMNAME,ITMSGRPNAM,ONHAND,PRICE,SALUNITMSR,SALPACKMSR FROM APP_ITEM WHERE EMPRESA='" + masterEmpresa.trim() + "'  AND (ITEMCODE LIKE '%" + ITEMCODE + "%' OR ITEMNAME LIKE '%" + ITEMNAME + "%' OR ITMSGRPNAM LIKE '%" + ITMSGRPNAM + "%' ) AND APRO_EXTERNO LIKE '%"+ filtro +"%' "+ ((filtro == "")? " AND ( CAST(ONHAND AS INT)>0 OR LIST_MAT LIKE '%Y%' ) " : " AND CAST(ONHAND AS INT)>0  ") +" ORDER BY ITEMCODE ASC LIMIT 50;", function (obj) {
                  
                  var data="";

                  for (var i = 0; i < obj.rows.length; i++) {
                      var row = obj.rows.item(i);

                      data = data +"<li style='overflow-x:scroll'><input name='chkItems' id='"+i+"' type='checkbox'><label for='"+i+"' style='padding-right: 3px;'><table class='' style='width: 100%'><tbody>                                                                                                                                            <tr style='color: #f39c12 !important;'><td style='width: 20%'><strong class='text-yellow'>Codigo</strong></td><td style='width: 40%'><strong class='text-yellow'>Descripción</strong></td><td style='width: 15%'><strong class='text-yellow'>Linea</strong></td><td style='width: 10%'><strong class='text-yellow'>Precio</strong></td><td style='width: 10%'><strong class='text-yellow'>Un</strong></td><td style='width: 5%'></td></tr>                                                                                            <tr><td id='tdCode"+i+"' style='width: 20%'>" + row.ITEMCODE + "</td><input type='hidden' id='tdOnhand"+i+"' value = '"+row.ONHAND+"'/><td style='width: 40%'>" + row.ITEMNAME + "</td><td style='width: 15%'>" + row.ITMSGRPNAM + "</td><td style='width: 10%'>" + parseFloat(row.PRICE).toFixed(AppDecimales) + "</td><td style='width: 10%'>" + row.SALUNITMSR + "</td><td style='width: 5%'> <button type='button' data-icon='gear' data-iconpos='right' data-mini='true' data-inline='true'  onclick='fn_FichaItem(\"" + row.ITEMCODE + "\")'>Ficha</button> </td></tr></tbody></table></label></li>";
                  };
                  $("#tagItemsSearch_Lineas").html(data);
                  $('#tagItemsSearch_Lineas').listview('refresh');
                  $("#tagItemsSearch_Lineas").trigger("create");
                  
                  $("#loader_sys_btn_hide").click();
            });
        }
    }

    function hideKeyboard(evento)
    {
        var key = validaEvento(evento);
        if (key == 13) {
            setTimeout(function() {
                var field = document.createElement('input');
                field.setAttribute('type', 'text');
                field.setAttribute('style', 'position:absolute; top: 0px; opacity: 0; -webkit-user-modify: read-write-plaintext-only; left:0px;');
                document.body.appendChild(field);
                field.onfocus = function(){
                    setTimeout(function() {
                        field.setAttribute('style', 'display:none;');
                        setTimeout(function() {
                            document.body.removeChild(field);
                            document.body.focus();
                        }, 14);
                    }, 50);
                };
                field.focus();
            }, 50);
        }
    }

    function fn_SeleccionItemsMultiple()
    {
        var idItemSel="";
        var cantItemSel="";
        var CANTSEL="";
        var DESCUENTO="";
        var PRICES="";
        var CANTTOTAL="";
        var CANTBACKORDER="";
        var checked = document.getElementsByName("chkItems");

        for (var i = 0; i < checked.length; i++) {
            if(checked[i].checked){
                idItemSel= idItemSel + "'" + $("#tdCode"+checked[i].id).html()+ "',";
                cantItemSel= cantItemSel + $("#tdCode"+checked[i].id).html()+"|"+ $("#tdOnhand"+checked[i].id).html()+",";
                CANTSEL= CANTSEL + $("#tdCode"+checked[i].id).html()+"|1,";
                DESCUENTO= DESCUENTO + $("#tdCode"+checked[i].id).html()+"|0,";
                PRICES= PRICES + $("#tdCode"+checked[i].id).html()+"|0,";
                CANTTOTAL= CANTTOTAL + $("#tdCode"+checked[i].id).html()+"|1,";
                CANTBACKORDER= CANTBACKORDER + $("#tdCode"+checked[i].id).html()+"|0,";
            }
        }

        fn_SeleccionItemsSearch(idItemSel+"'9-9-9'",cantItemSel,CANTSEL,DESCUENTO,PRICES,CANTTOTAL,CANTBACKORDER);
        setTimeout(function(){
            //$("#tagLineasPedido").accordion("refresh");
            //fn_AutoGuardar();
        },500);
        //fn_PopupItemsClose();
    }

    function fn_SeleccionItemsSearch(ITEMCODE,CANTACTUAL,CANTSEL,DESCUENTO,PRICES,CANTTOTAL,CANTBACKORDER) 
    {
        $("#containerItemClose").click();
        $("#loader_sys_btn_show").click();
        BDConsultaOBJ("SELECT IFNULL((SELECT APP_PRECIO_CLIENTE.PRICE FROM APP_PRECIO_CLIENTE WHERE APP_ITEM.ITEMCODE = APP_PRECIO_CLIENTE.ITEMCODE AND APP_ITEM.EMPRESA = APP_PRECIO_CLIENTE.EMPRESA AND APP_PRECIO_CLIENTE.CARDCODE = '"+$("#opt_ListaCliente").val()+"' ORDER BY APP_PRECIO_CLIENTE.DOCDATE LIMIT 1),'0') ULTPRECVENT, IFNULL((SELECT APP_PRECIO_CLIENTE.QUANTITY FROM APP_PRECIO_CLIENTE WHERE APP_ITEM.ITEMCODE = APP_PRECIO_CLIENTE.ITEMCODE AND APP_ITEM.EMPRESA = APP_PRECIO_CLIENTE.EMPRESA AND APP_PRECIO_CLIENTE.CARDCODE = '"+$("#opt_ListaCliente").val()+"' ORDER BY APP_PRECIO_CLIENTE.DOCDATE LIMIT 1),'0') ULTCANTVENT, APP_ITEM.* FROM APP_ITEM WHERE APP_ITEM.EMPRESA='"+masterEmpresa.trim()+"' AND APP_ITEM.ITEMCODE IN("+ITEMCODE+")", function (obj) {

              console.log(obj.rows.length);    
              var strPlantilla = $("#ItemPlantilla").html();

              for (var i = 0; i < obj.rows.length; i++) 
              {
                  var row = obj.rows.item(i);
                  var exist = true;
                  console.log(row.ITEMCODE);

                  for(var i_REG=0;i_REG<=i_LINES;i_REG++){
                      if(row.ITEMCODE == $("#tdITEMCODE"+i_REG).val())
                      {   
                          alert("El item \""+$("#tdITEMNAME"+i_REG).val()+"\" ya fue seleccionado!");
                          exist = false;
                      }
                  }

                  if(exist)
                  {
                      var Precios = "";
                      var regPrecios = PRICES.split(","); 
                      regPrecios = regPrecios.filter(Boolean)
                      for (var i = 0; i < regPrecios.length; i++)
                      {
                          var regPrecio = regPrecios[i].split("|");
                          if(regPrecio[0].trim() == row.ITEMCODE.trim())
                          {
                              Precios = ((regPrecio[1]==0)?parseFloat(row.PRICE).toFixed(AppDecimales):regPrecio[1]);
                              break;
                          }
                      }

                      var itemDetail="";
                      itemDetail= "<div data-role='collapsible' id='tr~'' data-collapsed='true'>"+strPlantilla+"</div>";
                      itemDetail= itemDetail.replace(/~/g, i_LINES);

                      $( "#tagLineasPedido" ).append( itemDetail ).collapsibleset( "refresh" );
                      //$("#tagLineasPedido").trigger("create");

                      $("#tdITEMNAMEFIRST"+i_LINES).html("  "+row.ITEMCODE);

                      var regCANTSEL = CANTSEL.split(","); 
                      regCANTSEL = regCANTSEL.filter(Boolean)
                      for (var i = 0; i < regCANTSEL.length; i++)
                      {
                          var regCANTS = regCANTSEL[i].split("|");
                          if(regCANTS[0].trim() == row.ITEMCODE.trim())
                          {
                              $("#tdQUANTITYFIRST"+i_LINES).html("# "+regCANTS[1]);
                              $("#tdQUANTITYStock"+i_LINES).html(regCANTS[1]);
                              $("#tdQUANTITY"+i_LINES).val(regCANTS[1]);
                              break;
                          }
                      }

                      var regDESCUENTO = DESCUENTO.split(","); 
                      regDESCUENTO = regDESCUENTO.filter(Boolean)
                      for (var i = 0; i < regDESCUENTO.length; i++)
                      {
                          var regDESC = regDESCUENTO[i].split("|");
                          if(regDESC[0].trim() == row.ITEMCODE.trim())
                          {
                              $("#tdDESCUENTOFIRST"+i_LINES).html("% "+regDESC[1]);
                              $("#tdDESCUENTO"+i_LINES).val(regDESC[1]);
                              $("#tdDESCUENTO2"+i_LINES).val( parseFloat(regDESC[1]).toFixed(2) );
                              break;
                          }
                      }

                      var regCANTTOTAL = CANTTOTAL.split(","); 
                      regCANTTOTAL = regCANTTOTAL.filter(Boolean)
                      for (var i = 0; i < regCANTTOTAL.length; i++)
                      {
                          var regCANTTOT = regCANTTOTAL[i].split("|");
                          if(regCANTTOT[0].trim() == row.ITEMCODE.trim())
                          {
                              $("#tdQUANTITYTotal"+i_LINES).html(regCANTTOT[1]);
                              break;
                          }
                      }

                      var regCANTBACKORDER = CANTBACKORDER.split(","); 
                      regCANTBACKORDER = regCANTBACKORDER.filter(Boolean)
                      for (var i = 0; i < regCANTBACKORDER.length; i++)
                      {
                          var regCANTBACK = regCANTBACKORDER[i].split("|");
                          if(regCANTBACK[0].trim() == row.ITEMCODE.trim())
                          {
                              $("#tdQUANTITYBackOrder"+i_LINES).html(regCANTBACK[1]);
                              break;
                          }
                      }


                      $("#tdPRICECOMERCIALFIRST"+i_LINES).html("$ "+Precios);
                      $("#tdTOTALFIRST"+i_LINES).html("$ "+ 0);

                      $("#tdITEMCODE"+i_LINES).val(row.ITEMCODE);
                      $("#tdITEMNAME"+i_LINES).val(row.ITEMNAME);
                      $("#tdSALUNITMSR"+i_LINES).html(row.SALUNITMSR);

                      $("#tdMINIMUM"+i_LINES).html(row.MINIMUM);
                      $("#tdMASTER"+i_LINES).html(row.MASTER);

                      $("#tdLISTMAT"+i_LINES).html(row.LIST_MAT.trim());

                      $("#tdPRICE"+i_LINES).val( parseFloat(row.PRICE).toFixed(AppDecimales));
                     
                      $("#tdPRICECOMERCIAL2"+i_LINES).val(parseFloat(Precios).toFixed(4));
                      $("#tdPRICECOMERCIAL"+i_LINES).val(Precios);
                      $("#tdPRICECOMERCIAL"+i_LINES).val(Precios);
                      $("#tdULTIMOPRECIOVENTA"+i_LINES).val(parseFloat(row.ULTPRECVENT).toFixed(AppDecimales));
                      $("#tdULTIMACANTVENTA"+i_LINES).val(parseFloat(row.ULTCANTVENT).toFixed(AppDecimales));

                      $("#tdNETO"+i_LINES).val(0);
                      $("#tdIMPUESTO"+i_LINES).val(row.VATLIABLE);
                      $("#tdTOTAL"+i_LINES).val(0);
                      
                      startCursor("tdQUANTITY"+i_LINES);
                      startCursor("tdDESCUENTO"+i_LINES);
                      startCursor("tdPRICECOMERCIAL"+i_LINES);
                      //SE ESTABLECE QUE SOLO NUMEROS SE INSERTARAN

                      SoloNumeroCantidad("tdQUANTITY"+i_LINES);
                      SoloNumero("tdPRICECOMERCIAL"+i_LINES);
                      SoloNumero("tdDESCUENTO"+i_LINES);

                      //FOCUS EN CANTIDAD
                      $("#tdQUANTITY"+i_LINES).focus();
                      //CALCULAR EN CADA CAMBIO
                      $("#tdCount"+i_LINES).html("# "+(i_LINESCOUNT)+" - ");
                      fn_CalculoDescuento();
                      fn_CalculoItemList();
                      
                      i_LINES = i_LINES+1;
                      i_LINESCOUNT = i_LINESCOUNT+1;
                      
                  }
              }

              /*var tdCount = document.getElementsByName("tdCount");
              for (var i = 0; i < tdCount.length; i++) {
                  tdCount[i].innerHTML = "# "+(i+1)+" - ";
              }*/
              $("#loader_sys_btn_hide").click();
        }); 
    }

    function fn_CalculoDescuento(){
        for(var i_REG=0;i_REG<=i_LINES;i_REG++)
        {
            if(typeof $("#tdITEMCODE"+i_REG).val()!='undefined'){
                if(!isNaN($("#tdPRICECOMERCIAL"+i_REG).val())){
                    //CALCULO LINEAS
                    var Precio          = $("#tdPRICE"+i_REG).val();
                    var PrecioComercial = SoloNumeroEmpty("tdPRICECOMERCIAL"+i_REG);
                    var Descuento       = (Precio-PrecioComercial)/Precio*100;
                    //CONVERTIR 6 DECIMALES
                    Descuento=parseFloat(Descuento).toFixed(AppDecimales);
                    //PRESENTACION LINEA
                    $("#tdDESCUENTO"+i_REG).val(Descuento);
                }
            }
        }
        fn_CalculoItemList();
    }

    //Funciones de Calculo
        function fn_CalculoItemList(ITEMCODE)
        { 
            var TOT_SUBTOTAL=0;
            var TOT_IMPUESTO=0;
            var TOT_TOTAL=0;
            var TOT_DESCPROM=0;
            var TOT_CONTADOR=0;

            if( parseInt($("#tdQUANTITY"+ITEMCODE).val()) != parseInt($("#tdQUANTITYStock"+ITEMCODE).html()))
            {
                $("#tdQUANTITYTotal"+ITEMCODE).html(parseInt( ($("#tdQUANTITY"+ITEMCODE).val() == "")? 0 : $("#tdQUANTITY"+ITEMCODE).val() ).toFixed(0));
                $("#tdQUANTITYStock"+ITEMCODE).html(parseInt( ($("#tdQUANTITY"+ITEMCODE).val() == "")? 0 : $("#tdQUANTITY"+ITEMCODE).val() ).toFixed(0));
                $("#tdQUANTITYBackOrder"+ITEMCODE).html(0);
            }
            //VERIFICAR SI HAY STOCK DISPONIBLE DEL ITEM ANTES DE HACER EL CALCULO
            if($("#idExtAprov").prop('checked') == false)
            {
                if(ITEMCODE!="")
                {
                    if(!isNaN($("#tdQUANTITY"+ITEMCODE).val()))
                    {
                        if( $("#tdLISTMAT"+ITEMCODE).html()=="N" )
                        {
                            $("#loader_sys_btn_show").click();
                            BDConsultaOBJ("SELECT * FROM APP_ITEM WHERE EMPRESA='"+masterEmpresa.trim()+"' AND ITEMCODE='"+ $("#tdITEMCODE"+ITEMCODE).val() +"' ORDER BY ITEMCODE ASC", function (obj) {
                                for (var i = 0; i < obj.rows.length; i++) {
                                    var row = obj.rows.item(i);

                                    if(parseInt(row.ONHAND) < parseInt($("#tdQUANTITY"+ITEMCODE).val())){
                                        alert("No hay disponible esa cantidad, stock "+ parseInt(row.ONHAND) +" und!");
                                        //alert("No hay cantidad requerida de Stock!");
                                        var cantBackOrder = parseInt($("#tdQUANTITY"+ITEMCODE).val()) - parseInt(row.ONHAND);
                                        $("#tdQUANTITYTotal"+ITEMCODE).html(parseInt($("#tdQUANTITY"+ITEMCODE).val()).toFixed(0));
                                        $("#tdQUANTITYBackOrder"+ITEMCODE).html(parseInt(cantBackOrder).toFixed(0));
                                        $("#tdQUANTITY"+ITEMCODE).val(parseInt(row.ONHAND).toFixed(0));
                                        $("#tdQUANTITYStock"+ITEMCODE).html(parseInt(row.ONHAND).toFixed(0));

                                        //fn_focus("tdQUANTITY"+ITEMCODE);
                                        fn_CalculoItemList();
                                    }
                                }
                                $("#loader_sys_btn_hide").click();
                            }); 
                        }
                    }
                }
            }

            for(var i_REG=0;i_REG<=i_LINES;i_REG++)
            {
                if(typeof $("#tdITEMCODE"+i_REG).val()!='undefined'){
                    //CALCULO LINEAS
                    if(!isNaN($("#tdQUANTITY"+i_REG).val())){
                         if(!isNaN($("#tdPRICECOMERCIAL"+i_REG).val())){
                            if(!isNaN($("#tdDESCUENTO"+i_REG).val())){
                                var Cantidad        = SoloNumeroEmpty("tdQUANTITY"+i_REG);
                                var PrecioComercial = SoloNumeroEmpty("tdPRICECOMERCIAL"+i_REG);
                                var Descuento       = SoloNumeroEmpty("tdDESCUENTO"+i_REG);

                                var Neto=Cantidad*PrecioComercial;
                                var Impuesto=$("#tdIMPUESTO"+i_REG).val();
                                var ImpuestoValor=0;
                                if(Impuesto.trim()=="Y"){ImpuestoValor=parseFloat(Neto)*parseFloat(strIVA);}
                                var Total=Neto+ImpuestoValor;

                                //CONVERTIR 6 DECIMALES
                                Neto=parseFloat(Neto).toFixed(AppDecimales);
                                ImpuestoValor=parseFloat(ImpuestoValor).toFixed(AppDecimales);
                                Total=parseFloat(Total).toFixed(AppDecimales);

                                //TOTALES SUMA
                                TOT_SUBTOTAL    =parseFloat(TOT_SUBTOTAL)+parseFloat(Neto);
                                TOT_IMPUESTO    =parseFloat(TOT_IMPUESTO)+parseFloat(ImpuestoValor);
                                TOT_TOTAL       =parseFloat(TOT_TOTAL)+parseFloat(Total);
                                //CALCULO DE DESCUENTO 
                                TOT_DESCPROM    =parseFloat(TOT_DESCPROM)+parseFloat(Descuento);
                                TOT_CONTADOR ++;
                                //MUESTRA DATOS EN CABECERA
                                $("#tdQUANTITYFIRST"+i_REG).html("# "+Cantidad);
                                $("#tdPRICECOMERCIALFIRST"+i_REG).html("$ "+parseFloat(PrecioComercial).toFixed(AppDecimales));
                                $("#tdDESCUENTOFIRST"+i_REG).html("% "+parseFloat(Descuento).toFixed(AppDecimales));
                                
                                $("#tdTOTALFIRST"+i_REG).html("$ "+parseFloat(Neto).toFixed(AppDecimales));
                                //PRESENTACION LINEA
                                $("#tdNETO"+i_REG).val(Neto);
                                $("#tdIMPUESTOVALOR"+i_REG).val(ImpuestoValor);
                                $("#tdTOTAL"+i_REG).val(Total);
                            }
                        }
                    }
                }
            }
            //CALCULO DE DESCUENTO
            var descPromedio = (TOT_CONTADOR == 0) ? 0 :(TOT_DESCPROM/TOT_CONTADOR);
            //PRESENTACION DE TOTALES
            $("#TOT_DESCPROM").html(parseFloat(descPromedio).toFixed(AppDecimales));
            $("#TOT_SUBTOTAL").html(parseFloat(TOT_SUBTOTAL).toFixed(AppDecimales));
            $("#TOT_IMPUESTO").html(parseFloat(TOT_IMPUESTO).toFixed(AppDecimales));
            $("#TOT_TOTAL").html(parseFloat(TOT_TOTAL).toFixed(AppDecimales));
        }

        function fn_CalculoPrecioComercial()
        {
            for(var i_REG=0;i_REG<=i_LINES;i_REG++)
            {
                if(typeof $("#tdITEMCODE"+i_REG).val()!='undefined'){
                    if(!isNaN($("#tdDESCUENTO"+i_REG).val())){
                        //CALCULO LINEAS
                        var Precio          = $("#tdPRICE"+i_REG).val();
                        var Descuento       = SoloNumeroEmpty("tdDESCUENTO"+i_REG);
                        var PrecioComercial = Precio-(Descuento * Precio / 100);
                        //CONVERTIR 6 DECIMALES
                        PrecioComercial=parseFloat(PrecioComercial).toFixed(AppDecimales);
                        //PRESENTACION LINEA
                        $("#tdPRICECOMERCIAL"+i_REG).val(PrecioComercial);
                    }
                }
            }
            fn_CalculoItemList(); 
        }

        function fn_CalculoDescuento()
        {
            for(var i_REG=0;i_REG<=i_LINES;i_REG++)
            {
                if(typeof $("#tdITEMCODE"+i_REG).val()!='undefined'){
                    if(!isNaN($("#tdPRICECOMERCIAL"+i_REG).val())){
                        //CALCULO LINEAS
                        var Precio          = $("#tdPRICE"+i_REG).val();
                        var PrecioComercial = SoloNumeroEmpty("tdPRICECOMERCIAL"+i_REG);
                        var Descuento       = (Precio-PrecioComercial)/Precio*100;
                        //CONVERTIR 6 DECIMALES
                        Descuento=parseFloat(Descuento).toFixed(AppDecimales);
                        //PRESENTACION LINEA
                        $("#tdDESCUENTO"+i_REG).val(Descuento);
                    }
                }
            }
            fn_CalculoItemList();
        }

    //Funcion de Borrar
        function fn_DeleteItemList(trId)
        {
            $("#loader_sys_btn_show").click();
            $("#"+trId).remove();

            var tdCount = document.getElementsByName("tdCount");
            for (var i = 0; i < tdCount.length; i++) {
                tdCount[i].innerHTML = "# "+(i+1)+" - ";
            }
            
            i_LINESCOUNT = tdCount.length;
            fn_CalculoItemList();
            $("#tagLineasPedido").collapsibleset( "refresh" );
            $("#loader_sys_btn_hide").click();

            /*setTimeout(function(){
                fn_AutoGuardar();
            },100);*/
        }
</script>

<style type="text/css">
    .ui-checkbox
    {
        width: 800px;
    }

    #tagLineasPedido input
    {
        text-align: right;
    }

    #tagLineasPedido label
    {
        padding-top: 15px;
    }
</style>



<div role="container" id="container" style="background: white;">

    <div data-role="tabs" id="tabs">
        <div data-role="navbar">
            <ul>
                <li><a href="#Cab" style="font-size: 16px;" data-ajax="false" id="HeadCab">Informacion Principal</a></li>
                <li><a href="#Det" style="font-size: 16px;" data-ajax="false" id="HeadDet">Detalle de Pedido</a></li>
            </ul>
        </div>

        <div id="Cab" class="ui-body-d ui-content">
            <div class="ui-field-contain"  >
                <label class="cus-label"><strong>Fecha de Creacion:</strong></label>
                <input type="text" id="tagFECHACREACION" style="padding-right: 7px;height: 55px;" readonly>
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong>Fecha de entega:</strong></label>
                <input class="text-blue" type="text" id="tagENTREGADATE1" name="inputModify" onkeypress="return false" onclick="datePickerAndroid('tagENTREGADATE1','Fecha de Entrega Pedido', 0 , 1 );" style="padding-right: 7px;height: 55px;">
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong>Numero SAC:</strong></label>
                <input type="text" id="tagNUMEROSAC" style="padding-right: 7px;height: 55px;" readonly>
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong >Numero SAP:</strong></label>
                <input type="text" id="tagNUMEROSAP" style="padding-right: 7px;height: 55px;" readonly>
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong>Codigo:</strong></label>
                <input type="text" id="tagCARDCODE" style="padding-right: 7px;height: 55px;" readonly>
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong>Nombres:</strong></label>
                <input type="text" id="tagCARDNAME" style="padding-right: 7px;height: 55px;" readonly>
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong>E-mail:</strong></label>
                <input class="text-blue" type="text" id="tagE_MAIL" name="inputModify" onkeypress="hideKeyboard(event);" style="padding-right: 7px;height: 55px;">
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong>Telf.:</strong></label>
                <input class="text-blue" type="text" id="tagPHONE1" name="inputModify" onkeypress="hideKeyboard(event);" maxlength="10" style="padding-right: 7px;height: 55px;" >
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong >Celular:</strong></label>
                <input class="text-blue" type="text" id="tagCELLPHONE1" name="inputModify" onkeypress="hideKeyboard(event);" maxlength="10" style="padding-right: 7px;height: 55px;" >
            </div>
            <div class="ui-field-contain"  >
                <label class="cus-label"><strong>Direccion:</strong></label>
                <select id="opt_ListaDireccion" style="width: 100%;height: 55px;"></select>
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong>Transporte:</strong></label>
                <select id="opt_ListaTransporte" style="width: 100%;height: 55px;"></select>
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong>Grupo:</strong></label>
                <input type="text" id="tagGRUPO" style="padding-right: 7px;height: 55px;" readonly>
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong >Ciudad:</strong></label>
                <input type="text" id="tagMAILCITY" style="padding-right: 7px;height: 55px;" readonly>
            </div>

            <div class="ui-field-contain"  >
                <label class="cus-label"><strong >Orden de Compra:</strong></label>
                <input class="text-blue" type="text" id='tagORDCOMPRA' name="inputModify" maxlength="10" placeholder="Ingresar número de Orden de Compra"  onkeypress="hideKeyboard(event);" style="padding-right: 7px;height: 55px;">
            </div>
        </div>

        <div id="Det">
            <div class="ui-grid-a ui-responsive" style="margin: 30px 0px;">
                <div class="ui-block-a">
                    <a href="#" class="ui-btn cus-suc-ele ui-btn-icon-left ui-icon-plus ui-btn-inline" onclick="fn_CambiarPage('container', 'containerItem')">Agregar Item</a>
                </div>
                <div class="ui-block-b">
                    <input name="checkbox-v-2a" id="checkbox-v-2a" type="checkbox"><label for="checkbox-v-2a" style="padding-right: 3px;">Aprovisionamiento Externo</label>
                </div>
            </div>

            <div data-role="collapsibleset" data-content-theme="a" data-iconpos="left" id="tagLineasPedido">
            </div>

            <div>
                <div class="ui-grid-a ui-responsive">
                    <div class="ui-block-a" style="padding: 15px">
                        <hr>
                        <div class="ui-grid-a ui-responsive">
                            <div class="ui-block-a" style="width: 100%">
                                <div class="ui-block-a" style="width: 50%">
                                    <label class="cus-label"><strong>(%):</strong></label>
                                </div>
                                <div class="ui-block-b" style="text-align: right;width: 50%;">
                                    <span id="TOT_DESCPROM">0.00</span>    
                                </div>
                            </div>
                        </div>
                        <hr>

                        <br>

                        <label><strong>Comentario:</strong></label>
                        <textarea style='width:100%; resize:none;height: 80px;' name="inputModify" id="NOTAS" maxlength="254"></textarea>
                    </div>
                    <div class="ui-block-b" style="padding: 15px">
                        <div style="width: 100%;text-align: center;">
                            <label><strong>Totales de Pedido</strong></label>
                        </div>
                        
                        <br>

                        <hr>

                        <div class="ui-grid-a ui-responsive">
                            <div class="ui-block-a" style="width: 100%">
                                <div class="ui-block-a" style="width: 50%">
                                    <label class="cus-label"><strong>SubTotal:</strong></label>
                                </div>
                                <div class="ui-block-b" style="text-align: right;width: 50%;">
                                    <label class="cus-label">$<span id="TOT_SUBTOTAL">0.000000</span></label>        
                                </div>
                            </div>
                        </div>
                        <hr>

                        <div class="ui-grid-a ui-responsive">
                            <div class="ui-block-a" style="width: 100%">
                                <div class="ui-block-a" style="width: 50%">
                                    <label class="cus-label"><strong>Impuestos:</strong></label>
                                </div>
                                <div class="ui-block-b" style="text-align: right;width: 50%;">
                                    <label class="cus-label">$<span id="TOT_IMPUESTO">0.000000</span></label>        
                                </div>
                            </div>
                        </div>
                        <hr>

                        <div class="ui-grid-a ui-responsive">
                            <div class="ui-block-a" style="width: 100%">
                                <div class="ui-block-a" style="width: 50%">
                                    <label class="cus-label"><strong>Total:</strong></label>
                                </div>
                                <div class="ui-block-b" style="text-align: right;width: 50%;">
                                    <label class="cus-label">$<span id="TOT_TOTAL">0.000000</span></label>        
                                </div>
                            </div>
                        </div>
                        <hr>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div data-role=""> 
        <div class="ui-grid-b">
            <div class="ui-block-a">
                <a href="#" class="ui-btn btn-lg-right ui-btn-icon-left ui-icon-delete" onclick="fn_Pedido();">Cancelar</a>
            </div>
            <div class="ui-block-b">
                <a href="#" class="ui-btn btn-lg-right cus-dan-ele ui-btn-icon-left ui-icon-check" onclick="fn_Guardar('PEDIDO');">Guardar Pedido</a>
            </div>
            <div class="ui-block-c">
                <a href="#" class="ui-btn btn-lg-right cus-suc-ele ui-btn-icon-left ui-icon-check" onclick="fn_Guardar('COTIZACION');">Guardar Cotizacion</a>
            </div>
        </div>
    </div>
  	
</div>

<div role="container" id="containerItem" style="padding: 15px;background: white;height: 100%x;display: none">
    <a href="#" class="ui-btn ui-icon-delete ui-btn-icon-right ui-corner-all" style="float: right; top: -10px;" id="containerItemClose" onclick="fn_CambiarPage('containerItem', 'container')">Cerrar</a>  
    <div style="padding: 50px 20px 0px 20px;">
        <input type="text" id="tagSearchITEMCODE" value="" placeholder="Atributo del item a buscar" onkeypress="fn_ListaItemsSearch(event)">
      	<a href="#" class="ui-btn cus-suc-ele ui-btn-icon-left ui-icon-plus" onclick="fn_SeleccionItemsMultiple();">Agregar Item</a>
    </div>
    <div style="overflow-y: scroll;overflow-x: scroll;height: 600px;padding: 0px 20px 0px 20px;" >
        <ul data-role="listview" data-inset="true" id="tagItemsSearch_Lineas" style="font-size: 5px;">
        </ul>
    </div>
</div>

<div id ="ItemPlantilla" style="display:none">
    <h3 >
      <table style="font-size:11pt;width: 100%"> 
          <tr>
              <td name="tdCount" id='tdCount~' style="width:2%">#</td>
              <td id='tdITEMNAMEFIRST~' style="width:28%">asas</td>
              <td id='tdQUANTITYFIRST~' style='font-weight:bold;color:#666;width:14%'></td>
              <td id='tdPRICECOMERCIALFIRST~' style='font-weight:bold;color:#666;width:17%'></td>
              <td id='tdDESCUENTOFIRST~' style='font-weight:bold;color:#666;width:17%'></td>
              <td id='tdTOTALFIRST~' style='font-weight:bold;color:#666; width:17%'></td>
              <td id='tdLISTMAT~' style='display: none'></td>
              <td style='font-weight:bold;color:#666; width:5%'>
                <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext" onclick='fn_DeleteItemList("tr~")'>Close</a>
              </td>
          </tr>
      </table>
    </h3>
    <ul data-role="listview" data-theme="a">
        <li>
            <div class="ui-grid-a ui-responsive">
                <div class="ui-block-a">
                    <label for="tdQUANTITY~" >Cantidad Stock:</label>
                </div>
                <div class="ui-block-b">
                    <input name="tdQUANTITY~" class="text-blue" onclick='fn_focus("tdQUANTITY~")' onkeypress="/*hideKeyboard(event);*/" onblur='return fn_CalculoItemList("~");' id="tdQUANTITY~" value="" type="text">
                </div>
            </div>
        </li>
        <li>
            <div class="ui-grid-a ui-responsive">
                <div class="ui-block-a">
                    <label for="tdPRICECOMERCIAL~">Prec. Comercial:</label>
                </div>
                <div class="ui-block-b">
                    <input name="tdPRICECOMERCIAL~" class="text-blue" onclick='fn_focus("tdPRICECOMERCIAL~")' onkeypress="/*hideKeyboard(event);*/" onkeyup ='return fn_CalculoDescuento();' id="tdPRICECOMERCIAL~" value="" type="text">
                </div>
            </div>
        </li>
        <li>
            <div class="ui-grid-a ui-responsive">
                <div class="ui-block-a">
                    <label for="tdDESCUENTO~">(%):</label>
                </div>
                <div class="ui-block-b">
                    <input name="tdDESCUENTO~" class="text-blue" onclick='fn_focus("tdDESCUENTO~")' onkeypress="/*hideKeyboard(event);*/" onkeyup ='return fn_CalculoPrecioComercial();' id="tdDESCUENTO~" value="" type="text">
                </div>
            </div>
        </li>
        <li>
            <div class="ui-grid-a ui-responsive">
                <div class="ui-block-a">
                    <label for="tdITEMCODE~">ItemCode:</label>
                </div>
                <div class="ui-block-b">
                    <input name="tdITEMCODE~" id="tdITEMCODE~" value="" type="text" readonly>
                </div>
            </div>
        </li>
        <li>
            <div class="ui-grid-a ui-responsive">
                <div class="ui-block-a">
                    <label for="tdITEMNAME~">Item:</label>
                </div>
                <div class="ui-block-b">
                    <input name="tdITEMNAME~" id="tdITEMNAME~" value="" type="text" readonly>
                </div>
            </div>
        </li>
        <li>
            <div class="ui-grid-b">
                <div class="ui-block-a">
                    <div class="ui-field-contain">
                        <label for="tdQUANTITYTotal~" style="padding-right: 25px;padding-top: 0px !important">C. Tot:</label>
                        <label id="tdQUANTITYTotal~" style=";padding-top: 0px !important">0.00</label>
                    </div>
                </div>
                <div class="ui-block-b">
                    <div class="ui-field-contain">
                        <label for="tdQUANTITYStock~" style="padding-right: 35px;padding-top: 0px !important">C. Stock:</label>
                        <label id="tdQUANTITYStock~" style=";padding-top: 0px !important">0.00</label>
                    </div>
                </div>
                <div class="ui-block-c">
                    <div class="ui-field-contain">
                        <label for="tdQUANTITYBackOrder~" style="padding-right: 55px;padding-top: 0px !important">C. BackOrd:</label>
                        <label id="tdQUANTITYBackOrder~" style=";padding-top: 0px !important">0.00</label>
                    </div>
                </div>
            </div>
        </li>
        <li>
          <div class="ui-grid-b">
              <div class="ui-block-a">
                <div class="ui-field-contain">
                    <label for="tdSALUNITMSR~" style="padding-right: 25px;padding-top: 0px !important">Unidad:</label>
                    <label id="tdSALUNITMSR~" style=";padding-top: 0px !important">UN</label>
                </div>
              </div>
              <div class="ui-block-b">
                <div class="ui-field-contain">
                    <label for="tdMINIMUM~" style="padding-right: 35px;padding-top: 0px !important">Minimo:</label>
                    <label id="tdMINIMUM~" style=";padding-top: 0px !important">0.00</label>
                </div>
              </div>
              <div class="ui-block-c">
                <div class="ui-field-contain">
                    <label for="tdMASTER~" style="padding-right: 55px;padding-top: 0px !important">Master:</label>
                    <label id="tdMASTER~" style=";padding-top: 0px !important">0.00</label>
                </div>
              </div>
          </div>
        </li>
        <li>
            <div class="ui-grid-a ui-responsive">
                <div class="ui-block-a">
                    <label for="tdPRICE~">Prec. Unit:</label>
                </div>
                <div class="ui-block-b">
                  <input name="tdPRICE~" id="tdPRICE~" value="" type="text" readonly>
                </div>
            </div>
        </li>
        <li>
            <div class="ui-grid-a ui-responsive">
              <div class="ui-block-a">
                  <label for="tdULTIMOPRECIOVENTA~">Ultimo Precio de Venta:</label>
              </div>
              <div class="ui-block-b">
                  <input name="tdULTIMOPRECIOVENTA~" id="tdULTIMOPRECIOVENTA~" value="" type="text" readonly>
              </div>
            </div>
        </li>
        <li>
            <div class="ui-grid-a ui-responsive">
              <div class="ui-block-a">
                  <label for="tdULTIMACANTVENTA~">Ultimo Cantidad Vendida:</label>
              </div>
              <div class="ui-block-b">
                  <input name="tdULTIMACANTVENTA~" id="tdULTIMACANTVENTA~" value="" type="text" readonly>
              </div>
            </div>
        </li>
        <li>
            <div class="ui-grid-a ui-responsive">
                <div class="ui-block-a">
                    <label for="tdNETO~">Neto:</label>
                </div>
                <div class="ui-block-b">
                    <input name="tdNETO~" id="tdNETO~" value="" type="text" readonly>
                </div>
            </div>
        </li>
        <li>
            <div class="ui-grid-a ui-responsive">
                <div class="ui-block-a">
                    <label for="tdIMPUESTOVALOR~">Impuesto:</label>
                </div>
                <div class="ui-block-b">
                    <input name="tdIMPUESTOVALOR~" id="tdIMPUESTOVALOR~" value="" type="text" readonly>
                    <input type='hidden' id='tdIMPUESTO~' />
                </div>
            </div>
        </li>
        <li>
            <div class="ui-grid-a ui-responsive">
                <div class="ui-block-a">
                    <label for="tdTOTAL~">Total:</label>
                </div>
                <div class="ui-block-b">
                    <input name="tdTOTAL~" id="tdTOTAL~" value="" type="text" readonly>
                </div>
            </div>
        </li>
    </ul>
</div>

<input type='hidden' id='hdn_CARDCODE' value=''/>
<input type="hidden" id="PedidoFormularioEstado" value="" />
<input type="hidden" id="PedidoFormularioDocEntry" value=""/>
<input type="hidden" id="hdn_pagina" value='1' />