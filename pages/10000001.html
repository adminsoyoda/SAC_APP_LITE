<script type="text/javascript">
	var Arr_CLIENTE = [];
  var i_LINES = 0;
  var e = jQuery.Event("keypress");e.which = 13;e.keyCode=13;
  var testEmail = /^[A-Z0-9._%+-]+@([A-Z0-9-]+\.)+[A-Z]{2,4}$/i;

  var FECHAAPERTURA = new Date();
  var IDGESTION=0;
  var CARDCODE="";
  var AppDecimales= 4 ;

	function fn_ListaItemsSearch(evento) 
  {
        var key = validaEvento(evento);
        var filtro = "";

        if ($('#idExtAprov').is(":checked"))
        {
          filtro = "Y";
        }

        if (key == 13) {
            //hideKeyboard(evento);        
            $("#loader_sys").show();
            var ITEMCODE=$("#tagSearchITEMCODE").val();
            var ITEMNAME=$("#tagSearchITEMNAME").val();
            var ITMSGRPNAM=$("#tagSearchITMSGRPNAM").val();

            BDConsultaOBJ("SELECT ITEMCODE,ITEMNAME,ITMSGRPNAM,ONHAND,PRICE,SALUNITMSR,SALPACKMSR FROM APP_ITEM WHERE EMPRESA='" + masterEmpresa.trim() + "'  AND (ITEMCODE LIKE '%" + ITEMCODE + "%' OR '" + ITEMCODE + "'=ITEMCODE)  AND (ITEMNAME LIKE '%" + ITEMNAME + "%' OR '" + ITEMNAME + "'=ITEMNAME) AND (ITMSGRPNAM LIKE '%" + ITMSGRPNAM + "%' OR '" + ITMSGRPNAM + "'= ITMSGRPNAM) AND APRO_EXTERNO LIKE '%"+ filtro +"%' "+ ((filtro == "")? " AND ( CAST(ONHAND AS INT)>0 OR LIST_MAT LIKE '%Y%' ) " : "") +" ORDER BY ITEMCODE ASC LIMIT 50;", function (obj) {
                  
                  var data="";

                  for (var i = 0; i < obj.rows.length; i++) {
                      var row = obj.rows.item(i);

                      data = data +"<li><input name='chkItems' id='"+i+"' type='checkbox'><label for='"+i+"' style='padding-right: 3px;'><table class='table table-hover table-striped' style='width: 100%'><tbody>                                                                                                                                            <tr style='color: #f39c12 !important;'><td style='width: 20%'><strong class='text-yellow'>Codigo</strong></td><td style='width: 40%'><strong class='text-yellow'>Descripci√≥n</strong></td><td style='width: 15%'><strong class='text-yellow'>Linea</strong></td><td style='width: 10%'><strong class='text-yellow'>Precio</strong></td><td style='width: 10%'><strong class='text-yellow'>Un</strong></td><td style='width: 5%'></td></tr>                                                                                            <tr><td id='tdCode"+i+"' style='width: 20%'>" + row.ITEMCODE + "</td><input type='hidden' id='tdOnhand"+i+"' value = '"+row.ONHAND+"'/><td style='width: 40%'>" + row.ITEMNAME + "</td><td style='width: 15%'>" + row.ITMSGRPNAM + "</td><td style='width: 10%'>" + parseFloat(row.PRICE).toFixed(AppDecimales) + "</td><td style='width: 10%'>" + row.SALUNITMSR + "</td><td style='width: 5%'> <button type='button' data-icon='gear' data-iconpos='right' data-mini='true' data-inline='true'  onclick='fn_FichaItem(\"" + row.ITEMCODE + "\")'>Ficha</button> </td></tr></tbody></table></label></li>";
                  };
                  $("#tagItemsSearch_Lineas").html(data);
                  $('#tagItemsSearch_Lineas').listview('refresh');
                  $("#tagItemsSearch_Lineas").trigger("create");
                  
                  $("#loader_sys").hide();
            });
        }
  }

  function hideKeyboard(evento)
  {
      var key = validaEvento(evento);
      if (key == 13) {
          setTimeout(function() {
              var field = document.createElement('input');
              field.setAttribute('type', 'text');
              field.setAttribute('style', 'position:absolute; top: 0px; opacity: 0; -webkit-user-modify: read-write-plaintext-only; left:0px;');
              document.body.appendChild(field);
              field.onfocus = function(){
                setTimeout(function() {
                  field.setAttribute('style', 'display:none;');
                  setTimeout(function() {
                    document.body.removeChild(field);
                    document.body.focus();
                  }, 14);
                }, 50);
              };
              field.focus();
          }, 50);
      }
  }

  function fn_SeleccionItemsMultiple(){
      var idItemSel="";
      var cantItemSel="";
      var CANTSEL="";
      var DESCUENTO="";
      var PRICES="";
      var CANTTOTAL="";
      var CANTBACKORDER="";
      var checked = document.getElementsByName("chkItems");

      for (var i = 0; i < checked.length; i++) {
          if(checked[i].checked){
            idItemSel= idItemSel + "'" + $("#tdCode"+checked[i].id).html()+ "',";
            cantItemSel= cantItemSel + $("#tdCode"+checked[i].id).html()+"|"+ $("#tdOnhand"+checked[i].id).html()+",";
            CANTSEL= CANTSEL + $("#tdCode"+checked[i].id).html()+"|1,";
            DESCUENTO= DESCUENTO + $("#tdCode"+checked[i].id).html()+"|0,";
            PRICES= PRICES + $("#tdCode"+checked[i].id).html()+"|0,";
            CANTTOTAL= CANTTOTAL + $("#tdCode"+checked[i].id).html()+"|1,";
            CANTBACKORDER= CANTBACKORDER + $("#tdCode"+checked[i].id).html()+"|0,";
          }
      }

      fn_SeleccionItemsSearch(idItemSel+"'9-9-9'",cantItemSel,CANTSEL,DESCUENTO,PRICES,CANTTOTAL,CANTBACKORDER);
      setTimeout(function(){
          //$("#tagLineasPedido").accordion("refresh");
          //fn_AutoGuardar();
      },500);
      //fn_PopupItemsClose();
  }

  function fn_SeleccionItemsSearch(ITEMCODE,CANTACTUAL,CANTSEL,DESCUENTO,PRICES,CANTTOTAL,CANTBACKORDER) {
      $("#popupMenuItemClose").click();
      BDConsultaOBJ("SELECT IFNULL((SELECT APP_PRECIO_CLIENTE.PRICE FROM APP_PRECIO_CLIENTE WHERE APP_ITEM.ITEMCODE = APP_PRECIO_CLIENTE.ITEMCODE AND APP_ITEM.EMPRESA = APP_PRECIO_CLIENTE.EMPRESA AND APP_PRECIO_CLIENTE.CARDCODE = '"+$("#opt_ListaCliente").val()+"' ORDER BY APP_PRECIO_CLIENTE.DOCDATE LIMIT 1),'0') ULTPRECVENT, IFNULL((SELECT APP_PRECIO_CLIENTE.QUANTITY FROM APP_PRECIO_CLIENTE WHERE APP_ITEM.ITEMCODE = APP_PRECIO_CLIENTE.ITEMCODE AND APP_ITEM.EMPRESA = APP_PRECIO_CLIENTE.EMPRESA AND APP_PRECIO_CLIENTE.CARDCODE = '"+$("#opt_ListaCliente").val()+"' ORDER BY APP_PRECIO_CLIENTE.DOCDATE LIMIT 1),'0') ULTCANTVENT, APP_ITEM.* FROM APP_ITEM WHERE APP_ITEM.EMPRESA='"+masterEmpresa.trim()+"' AND APP_ITEM.ITEMCODE IN("+ITEMCODE+")", function (obj) {
            var strPlantilla = $("#ItemPlantilla").html();
            for (var i = 0; i < obj.rows.length; i++) 
            {
                var row = obj.rows.item(i);
                var itemDetail="";
                var exist = true;
                for(var i_REG=0;i_REG<=i_LINES;i_REG++){
                    if(row.ITEMCODE == $("#tdITEMCODE"+i_REG).html())
                    {   
                        alert("El item \""+$("#tdITEMNAME"+i_REG).html()+"\" ya fue seleccionado!");
                        exist = false;
                    }
                }

                if(exist)
                {
                    var Precios = "";
                    var regPrecios = PRICES.split(","); 
                    regPrecios = regPrecios.filter(Boolean)
                    for (var i = 0; i < regPrecios.length; i++)
                    {
                        var regPrecio = regPrecios[i].split("|");
                        if(regPrecio[0].trim() == row.ITEMCODE.trim())
                        {
                            Precios = ((regPrecio[1]==0)?parseFloat(row.PRICE).toFixed(AppDecimales):regPrecio[1]);
                            break;
                        }
                    }

                    itemDetail= "<div data-role='collapsible' id='tr~'' data-collapsed='true'>"+strPlantilla+"</div>";;
                    itemDetail= itemDetail.replace(/~/g, i_LINES);
                    console.log(itemDetail)
                    $( "#tagLineasPedido" ).append( itemDetail ).collapsibleset( "refresh" );
                    //$("#tagLineasPedido").trigger("create");

                    $("#tdITEMNAMEFIRST"+i_LINES).html("  "+row.ITEMCODE);

                    var regCANTSEL = CANTSEL.split(","); 
                    regCANTSEL = regCANTSEL.filter(Boolean)
                    for (var i = 0; i < regCANTSEL.length; i++)
                    {
                        var regCANTS = regCANTSEL[i].split("|");
                        if(regCANTS[0].trim() == row.ITEMCODE.trim())
                        {
                            $("#tdQUANTITYFIRST"+i_LINES).html("# "+regCANTS[1]);
                            $("#tdQUANTITYStock"+i_LINES).html(regCANTS[1]);
                            $("#tdQUANTITY"+i_LINES).val(regCANTS[1]);
                            break;
                        }
                    }

                    var regDESCUENTO = DESCUENTO.split(","); 
                    regDESCUENTO = regDESCUENTO.filter(Boolean)
                    for (var i = 0; i < regDESCUENTO.length; i++)
                    {
                        var regDESC = regDESCUENTO[i].split("|");
                        if(regDESC[0].trim() == row.ITEMCODE.trim())
                        {
                            $("#tdDESCUENTOFIRST"+i_LINES).html("% "+regDESC[1]);
                            $("#tdDESCUENTO"+i_LINES).val(regDESC[1]);
                            $("#tdDESCUENTO2"+i_LINES).val( parseFloat(regDESC[1]).toFixed(2) );
                            break;
                        }
                    }

                    var regCANTTOTAL = CANTTOTAL.split(","); 
                    regCANTTOTAL = regCANTTOTAL.filter(Boolean)
                    for (var i = 0; i < regCANTTOTAL.length; i++)
                    {
                        var regCANTTOT = regCANTTOTAL[i].split("|");
                        if(regCANTTOT[0].trim() == row.ITEMCODE.trim())
                        {
                            $("#tdQUANTITYTotal"+i_LINES).html(regCANTTOT[1]);
                            break;
                        }
                    }

                    var regCANTBACKORDER = CANTBACKORDER.split(","); 
                    regCANTBACKORDER = regCANTBACKORDER.filter(Boolean)
                    for (var i = 0; i < regCANTBACKORDER.length; i++)
                    {
                        var regCANTBACK = regCANTBACKORDER[i].split("|");
                        if(regCANTBACK[0].trim() == row.ITEMCODE.trim())
                        {
                            $("#tdQUANTITYBackOrder"+i_LINES).html(regCANTBACK[1]);
                            break;
                        }
                    }


                    $("#tdPRICECOMERCIALFIRST"+i_LINES).html("$ "+Precios);
                    $("#tdTOTALFIRST"+i_LINES).html("$ "+ 0);

                    $("#tdITEMCODE"+i_LINES).html(row.ITEMCODE);
                    $("#tdITEMNAME"+i_LINES).html(row.ITEMNAME);
                    $("#tdSALUNITMSR"+i_LINES).html(row.SALUNITMSR);

                    $("#tdMINIMUM"+i_LINES).html(row.MINIMUM);
                    $("#tdMASTER"+i_LINES).html(row.MASTER);

                    $("#tdLISTMAT"+i_LINES).html(row.LIST_MAT.trim());

                    $("#tdPRICE"+i_LINES).html( parseFloat(row.PRICE).toFixed(AppDecimales));
                   
                    $("#tdPRICECOMERCIAL2"+i_LINES).val(parseFloat(Precios).toFixed(4));
                    $("#tdPRICECOMERCIAL"+i_LINES).val(Precios);
                    $("#tdPRICECOMERCIAL"+i_LINES).val(Precios);
                    $("#tdULTIMOPRECIOVENTA"+i_LINES).html(parseFloat(row.ULTPRECVENT).toFixed(AppDecimales));
                    $("#tdULTIMACANTVENTA"+i_LINES).html(parseFloat(row.ULTCANTVENT).toFixed(AppDecimales));

                    $("#tdNETO"+i_LINES).html(0);
                    $("#tdIMPUESTO"+i_LINES).val(row.VATLIABLE);
                    $("#tdTOTAL"+i_LINES).html(0);
                    
                    startCursor("tdQUANTITY"+i_LINES);
                    startCursor("tdDESCUENTO"+i_LINES);
                    startCursor("tdPRICECOMERCIAL"+i_LINES);
                    //SE ESTABLECE QUE SOLO NUMEROS SE INSERTARAN

                    /*SoloNumeroCantidad("tdQUANTITY"+i_LINES);
                    SoloNumero("tdPRICECOMERCIAL"+i_LINES);
                    SoloNumero("tdDESCUENTO"+i_LINES);*/

                    //FOCUS EN CANTIDAD
                    $("#tdQUANTITY"+i_LINES).focus();
                    //CALCULAR EN CADA CAMBIO

                    /*fn_CalculoDescuento();
                    fn_CalculoItemList();*/
                    
                    i_LINES=i_LINES+1;
                }
            }
      }); 
  }

  function fn_DeleteItemList(trId){
      $("#"+trId).remove();
      $("#tagLineasPedido").collapsibleset( "refresh" );
  }

</script>

<div role="container" id="container" style="padding: 15px;background: white;">
	<div class="ui-grid-a ui-responsive">
	    <div class="ui-block-a">
	    	<a href="#popupMenuItem" data-rel="popup" data-transition="slideup" class="ui-btn cus-suc-ele ui-btn-icon-left ui-icon-plus ui-btn-inline" onclick="">Agregar Item</a>
	    </div>
	    <div class="ui-block-b">
	    	<input name="checkbox-v-2a" id="checkbox-v-2a" type="checkbox"><label for="checkbox-v-2a" style="padding-right: 3px;">Aprovisionamiento Externo</label>
	    </div>
	</div>
	<div data-role="collapsibleset" data-content-theme="a" data-iconpos="left" id="tagLineasPedido">
	</div>
</div>

<div data-role="popup" id="popupMenuItem" data-overlay-theme="a" data-theme="a" style="width: 100%;height: 100%;" data-dismissible="false">
    <a href="#" data-rel="back" id="popupMenuItemClose" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right cus-btn-lg">Close</a>
    <div style="padding: 20px 20px 0px 20px;height: 40%;">
    	<input type="text" id="tagSearchITEMCODE" value="" placeholder="Codigo de Item" onkeypress="fn_ListaItemsSearch(event)">
    	<input type="text" id="tagSearchITEMNAME" value="" placeholder="Nombre de Item" onkeypress="fn_ListaItemsSearch(event)">
    	<input type="text" id="tagSearchITMSGRPNAM" value="" placeholder="Linea de Item" onkeypress="fn_ListaItemsSearch(event)">
    	<a href="#" class="ui-btn cus-suc-ele ui-btn-icon-left ui-icon-plus" onclick="fn_SeleccionItemsMultiple();">Agregar Item</a>
    </div>
    <div style="overflow-y: scroll;height: 60%;" >
        <ul data-role="listview" data-inset="true" id="tagItemsSearch_Lineas" style="font-size: 5px;">
        </ul>
    </div>
</div>

<div id ="ItemPlantilla" style="display:none">
        <h3 >
          <table style="font-size:11pt;width: 100%"> 
              <tr>
                  <td id='tdITEMNAMEFIRST~' style="width:30%">asas</td>
                  <td id='tdQUANTITYFIRST~' style='font-weight:bold;color:#666;width:14%'></td>
                  <td id='tdPRICECOMERCIALFIRST~' style='font-weight:bold;color:#666;width:17%'></td>
                  <td id='tdDESCUENTOFIRST~' style='font-weight:bold;color:#666;width:17%'></td>
                  <td id='tdTOTALFIRST~' style='font-weight:bold;color:#666; width:17%'></td>
                  <td id='tdLISTMAT~' style='display: none'></td>
                  <td style='font-weight:bold;color:#666; width:5%'>
                    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext" onclick='fn_DeleteItemList("tr~")'>Close</a>
                  </td>
              </tr>
          </table>
        </h3>
        <ul data-role="listview" data-theme="a">
            <li>
                <div class="ui-grid-a ui-responsive">
                    <div class="ui-block-a">
                        <label for="tdQUANTITY~">Cantidad Stock:</label>
                    </div>
                    <div class="ui-block-b">
                        <input name="tdQUANTITY~" id="tdQUANTITY~" value="" type="text">
                    </div>
                </div>
            </li>
            <li>
                <div class="ui-grid-a ui-responsive">
                    <div class="ui-block-a">
                        <label for="tdPRICECOMERCIAL~">Prec. Comercial:</label>
                    </div>
                    <div class="ui-block-b">
                      <input name="tdPRICECOMERCIAL~" id="tdPRICECOMERCIAL~" value="" type="text">
                    </div>
                </div>
            </li>
            <li>
                <div class="ui-grid-a ui-responsive">
                    <div class="ui-block-a">
                        <label for="tdDESCUENTO~">(%):</label>
                    </div>
                    <div class="ui-block-b">
                      <input name="tdDESCUENTO~" id="tdDESCUENTO~" value="" type="text">
                    </div>
                </div>
            </li>
            <li>
                <div class="ui-grid-a ui-responsive">
                    <div class="ui-block-a">
                        <label for="tdITEMCODE~">ItemCode:</label>
                    </div>
                    <div class="ui-block-b">
                      <input name="tdITEMCODE~" id="tdITEMCODE~" value="" type="text">
                    </div>
                </div>
            </li>
            <li>
                <div class="ui-field-contain">
                    <label for="tdITEMNAME~">Item:</label>
                    <input name="tdITEMNAME~" id="tdITEMNAME~" value="" type="text">
                </div>
            </li>
            <li>
                <div class="ui-grid-b">
                    <div class="ui-block-a">
                        <div class="ui-field-contain">
                            <label for="tdQUANTITYTotal~" style="padding-right: 15px">C. Tot:</label>
                            <label id="tdQUANTITYTotal~">0.00</label>
                        </div>
                    </div>
                    <div class="ui-block-b">
                        <div class="ui-field-contain">
                            <label for="tdQUANTITYStock~" style="padding-right: 25px">C. Stock:</label>
                            <label id="tdQUANTITYStock~">0.00</label>
                        </div>
                    </div>
                    <div class="ui-block-c">
                        <div class="ui-field-contain">
                            <label for="tdQUANTITYBackOrder~" style="padding-right: 45px">C. BackOrd:</label>
                            <label id="tdQUANTITYBackOrder~">0.00</label>
                        </div>
                    </div>
                </div>
            </li>
            <li>
              <div class="ui-grid-b">
                  <div class="ui-block-a">
                    <div class="ui-field-contain">
                        <label for="tdSALUNITMSR~" style="padding-right: 15px">Unidad:</label>
                        <label id="tdSALUNITMSR~">UN</label>
                    </div>
                  </div>
                  <div class="ui-block-b">
                    <div class="ui-field-contain">
                        <label for="tdMINIMUM~" style="padding-right: 25px">Minimo:</label>
                        <label id="tdMINIMUM~">0.00</label>
                    </div>
                  </div>
                  <div class="ui-block-c">
                    <div class="ui-field-contain">
                        <label for="tdMASTER~" style="padding-right: 45px">Master:</label>
                        <label id="tdMASTER~">0.00</label>
                    </div>
                  </div>
              </div>
            </li>
            <li>
                <div class="ui-grid-a ui-responsive">
                    <div class="ui-block-a">
                        <label for="tdPRICE~">Prec. Unit:</label>
                    </div>
                    <div class="ui-block-b">
                      <input name="tdPRICE~" id="tdPRICE~" value="" type="text">
                    </div>
                </div>
            </li>
            <li>
                <div class="ui-grid-a ui-responsive">
                  <div class="ui-block-a">
                      <label for="tdULTIMOPRECIOVENTA~">Ultimo Precio de Venta:</label>
                  </div>
                  <div class="ui-block-b">
                    <input name="tdULTIMOPRECIOVENTA~" id="tdULTIMOPRECIOVENTA~" value="" type="text">
                  </div>
                </div>
            </li>
            <li>
                <div class="ui-grid-a ui-responsive">
                  <div class="ui-block-a">
                      <label for="tdULTIMACANTVENTA~">Ultimo Cantidad Vendida:</label>
                  </div>
                  <div class="ui-block-b">
                    <input name="tdULTIMACANTVENTA~" id="tdULTIMACANTVENTA~" value="" type="text">
                  </div>
                </div>
            </li>
            <li>
                <div class="ui-grid-a ui-responsive">
                    <div class="ui-block-a">
                        <label for="tdNETO~">Neto:</label>
                    </div>
                    <div class="ui-block-b">
                        <input name="tdNETO~" id="tdNETO~" value="" type="text">
                    </div>
                </div>
            </li>
            <li>
                <div class="ui-grid-a ui-responsive">
                    <div class="ui-block-a">
                      <label for="tdIMPUESTOVALOR~">Impuesto:</label>
                    </div>
                    <div class="ui-block-b">
                        <input name="tdIMPUESTOVALOR~" id="tdIMPUESTOVALOR~" value="" type="text">
                    </div>
                </div>
            </li>
            <li>
                <div class="ui-grid-a ui-responsive">
                    <div class="ui-block-a">
                      <label for="tdTOTAL~">Total:</label>
                    </div>
                    <div class="ui-block-b">
                        <input name="tdTOTAL~" id="tdTOTAL~" value="" type="text">
                    </div>
                </div>
            </li>
        </ul>
</div>